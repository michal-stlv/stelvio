# AWS S3 (Object Storage)

## S3 Buckets

Stelvio supports creating and managing S3 buckets using the `Bucket` component.

Create an S3 bucket and link it to an API Gateway handler:

```python
@app.run
def run() -> None:
    bucket = Bucket("todo-bucket")

    api = Api("todo-api")
    api.route("GET", "/write", handler="functions/write.get", links=[bucket])
    api.route("GET", "/read", handler="functions/read.get", links=[bucket])
```

Using the [linking mechanism](/guides/linking), you can easily access the S3 bucket in your Lambda functions using the regular [`boto3`](https://boto3.amazonaws.com/) library:

```python
import boto3
from stlv_resources import Resources


def get(event, context):
    s3_client = boto3.client("s3")
    bucket_name = Resources.todoBucket.bucket_name
    s3_client.put_object(Bucket=bucket_name, Key="hello.txt", Body="Hello, World!")
    return {"statusCode": 200, "body": "Hello, World!"}
```

### Storage Classes

In order to use a storage class other than `STANDARD` class, we can use Pulumi's `aws.s3.BucketLifecycleRuleArgs`.

Here is an example to apply lifecycle rules on the bucket to transition objects to the Glacier storage class:

```python
@app.run
def run() -> None:
    bucket = Bucket("todo-bucket",
                    lifecycle_rules=[pulumi_aws.s3.BucketLifecycleRuleArgs(
                        enabled=True,
                        id="transition-to-glacier",
                        transitions=[pulumi_aws.s3.BucketLifecycleRuleTransitionArgs(
                            days=0,  # immediately transition after upload
                            storage_class="GLACIER"
                        )],
                    )])
```


### Public Access


Internally, access to S3 buckets is handled by the `pulumi_aws.s3.BucketPublicAccessBlock` resource.


By default, all public access is blocked for S3 buckets created with the `Bucket` component. 
You can change that behaviour by setting the `prevent_public_access` argument to `False`:

```python
@app.run
def run() -> None:
    bucket = Bucket("todo-bucket", prevent_public_access=False)
```

Internally, a `BucketPublicAccessBlock` is created with the following parameters:

```python
    block_public_acls=self.prevent_public_access,
    block_public_policy=self.prevent_public_access,
    ignore_public_acls=self.prevent_public_access,
    restrict_public_buckets=self.prevent_public_access,
```

If you need more granular access to those parameters, you can override the `public_access_block_args` argument when creating the `Bucket` component:

```python
@app.run
def run() -> None:
    bucket = Bucket("todo-bucket", public_access_block_args={
        "block_public_acls": False,
        "block_public_policy": False,
        "ignore_public_acls": False,
        "restrict_public_buckets": False,
    })
```

| Parameter                | Description                                                                 |
|--------------------------|-----------------------------------------------------------------------------|
| `block_public_acls`      | Whether to block public ACLs.                                               |
| `block_public_policy`    | Whether to block public policies.                                           |
| `ignore_public_acls`     | Whether to ignore public ACLs.                                              |
| `restrict_public_buckets`| Whether to restrict public buckets.                                         |

See the [Pulumi Documentation](https://www.pulumi.com/registry/packages/aws/api-docs/s3/bucketpublicaccessblock/) for more information.

## Static Websites

Future releases of Stelvio will allow public access to S3 buckets, like static websites, using Cloudfront. This is still in development.